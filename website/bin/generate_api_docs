#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/setup'
require 'yard'
require 'fileutils'

# Path to the wytch gem lib directory
WYTCH_LIB_PATH = File.expand_path('../../lib', __dir__)
API_CONTENT_DIR = File.expand_path('../content/api', __dir__)

puts "Cleaning existing API documentation..."
FileUtils.rm_rf(API_CONTENT_DIR)
FileUtils.mkdir_p(API_CONTENT_DIR)

puts "Parsing YARD documentation from #{WYTCH_LIB_PATH}..."
YARD.parse("#{WYTCH_LIB_PATH}/**/*.rb")

puts "Generating API content files..."
YARD::Registry.all(:class).each do |klass|
  # Convert Wytch::Page to wytch/page
  path_segments = klass.path.split('::').map(&:downcase)
  
  # Create directory structure
  dir_path = File.join(API_CONTENT_DIR, *path_segments[0..-2])
  FileUtils.mkdir_p(dir_path) if path_segments.length > 1
  
  # Create content file
  file_path = File.join(API_CONTENT_DIR, *path_segments) + '.rb'
  
  File.write(file_path, <<~RUBY)
    # frozen_string_literal: true
    
    view WytchSite::ApiClassView
    
    @metadata[:title] = "#{klass.path}"
    @metadata[:yard_path] = "#{klass.path}"
  RUBY
  
  puts "  Created #{file_path.sub(API_CONTENT_DIR + '/', '')}"
end

puts "\nGenerated #{YARD::Registry.all(:class).count} API documentation pages"
puts "Run 'wytch build' to build the site"
